#! /usr/bin/perl
# 20070620jd
# 20091113jd:  erweiterung um gethostbyaddr+gethostbyname bei -H ($host_match)
# 20100708jd:  erweiterung ausgabe hostvariablen

use strict;
use Socket;

sub usage ()
{

print '
get_config  [-i instanz] [-h|H host] [-s service]  [--quiet]   [ --detail | [--add_host_info] [--add_cmd_info] [--add_cont_info] ]
get_config  [-i instanz] --contacts
get_config  [-i instanz] --all [--quiet]   [ --detail  | [--add_host_info] [--add_cmd_info] [--add_cont_info] ]
get_config --help

        --help ............ show help
        -h oder -H ........ h--> host-objectname; H--> host objectname,alias,dns
        --quiet ........... keine ausgabe; nur returncode ob host[/service] vorhanden
        --add_host_info ... zusaetzliche hostinfo
        --add_cmd_info .... check_command anzeigen
        --add_cont_info ... contact_group anzeigen
        --detail .......... --add_host_info + --add_cmd_info + --add_cont_info

        --all ............. show hostgroups,hosts,services, contacts

        --contacts ........ show contacts
        
         -i ....... instance (=side; default: central)
';
        exit 99;

}

my      $inst = $ENV{'INST'};
$inst = "central" if ($inst eq "");
my $confprefix="/opt/omd/sites/";
my $confsuffix="/var/naemon/objects.cache";
my $conf = $confprefix.$inst.$confsuffix ;


my      $host = "" ;
my      $host_match = "" ;
my      $svc = "" ;
my      $line ;
my      $cmd_line ;
my      $o = "" ;
my      $a = "" ;
my      $c = "" ;
my      $x = "" ;
my      $l = "" ;
my      $v = "" ;
my      $add_host_info = 0 ;
my      $add_cmd_info = 0 ;
my      $add_cont_info = 0 ;
my      $contact_info = 0 ;
my      $all = 0 ;
my      $quiet = 1;
my      $e = 1 ;
my      $h_serach_mod="h";
my      $hn;
my      $ft;
my      $parents;

while ($ARGV[0] =~ /^-/)
{
        my $arg = shift @ARGV;
        if ($arg =~ /^--help$/)
        {
                usage;
                exit;
        }
        elsif ($arg =~ /^--?i(nst)?$/)
        {
                $inst  = shift @ARGV;
                $conf = $confprefix.$inst.$confsuffix ;
        }
        elsif ($arg =~ /^--?h(ost)?$/)
        {
                $host  = shift @ARGV;
                $host_match = "#$host#";
        }
        elsif ($arg =~ /^--?H(ost)?$/)
        {
                $host  = shift @ARGV;
                $h_serach_mod="H";
                # 20091113jd
                if ( $host =~ /^\d+\.\d+\.\d+\.\d+$/ )
                {
                        $host_match = gethostbyaddr( inet_aton($host), AF_INET );
                        ( my $d_name , my $d_alias, my $d_addrtype, my $d_lenght, my @d_addrs) = gethostbyname($host_match) ;


                        $host_match = "#$host_match#$d_name#$d_alias#";
                } else {
                        ( my $d_name , my $d_alias, my $d_addrtype, my $d_lenght, my @d_addrs) = gethostbyname($host) ;
                        $host_match = sprintf ("%d.%d.%d.%d", unpack ('C4', $d_addrs[0])  );
                        if ( $host_match =~ /^0\.0\.0\.0$/ )
                        {
                                $host_match = "#$host#";
                        } else {
                                $host_match = "#$host_match#$d_name#$d_alias#";
                        }
                }
                $host_match = "#$host#" if ( $host_match eq "" );

                $host_match =~ s/ /#/g ;
                $host_match =~ s/##/#/g ;
                $host_match = "#$host#" if ( $host_match eq "##" );

                #print "$host --> $host_match\n";
        }
        elsif ($arg =~ /^--?s(ervice)?$/)
        {
                $svc  = shift @ARGV;
        }

        elsif ($arg =~ /^--?q(uiet)?$/)
        {
                $quiet = 0 ;
        }
        elsif ($arg =~ /^--add_host_info$/)
        {
                $add_host_info = 1 ;
        }
        elsif ($arg =~ /^--add_cmd_info$/)
        {
                $add_cmd_info = 1 ;
        }
        elsif ($arg =~ /^--add_cont_info$/)
        {
                $add_cont_info = 1 ;
        }
        elsif ($arg =~ /^--all$/)
        {
                $h_serach_mod="a";
                $contact_info = 1;
                $all = 1 ;
        }
        elsif ($arg =~ /^--detail$/)
        {
                $add_cmd_info = 1 ;
                $add_host_info = 1 ;
                $add_cont_info = 1 ;
        }
        elsif ($arg =~ /^--contacts$/)
        {
                $contact_info = 1 ;
        }

}



open(CFG, $conf) or die "Error: can't open $conf\n";

CFG: while ($line = <CFG>)
{
        chomp($line);

        next if ( $line =~  /^\s*#/ );

        if ( $line =~  /^\s*$/ )
        {       $o = "";
                $c = "" ;
                $a = "" ;
                next;
        }

        if ( $line =~  /define\s+/ )
        {       $o = $line;
                $o =~ s/define\s+// ;
                $o =~ s/\s.*// ;
        }

        next if ( $o eq "" ) ;

        CASE_OBJ: {
                $o eq "contact" && do
                        {
                                if ($contact_info == 0 )
                                {       $o = "";
                                }else{
#print "$line\n";
                                        if ( $line =~  /^\s*contact_name\s+/ )
                                        {
                                                $l = $line;
                                                $l =~ s/^\s*contact_name\s+// ;
                                                $l = " C: " . $l ;
                                        }
                                        if ( $line =~  /^\s*alias\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*alias\s+// ;
                                                $l = $l . " (" . $x . ") svc/host:" ;
                                        }
                                        if ( $line =~  /^\s*service_notification_period\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*service_notification_period\s+// ;
                                                $l = $l . "  " . $x . "/" ;
                                        }
                                        if ( $line =~  /^\s*host_notification_period\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*host_notification_period\s+// ;
                                                $l = $l . $x ;
                                        }
                                        if ( $line =~  /^\s*service_notification_options\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*service_notification_options\s+// ;
                                                $l = $l . "  " . $x . "/" ;
                                        }
                                        if ( $line =~  /^\s*host_notification_options\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*host_notification_options\s+// ;
                                                $l = $l . $x ;
                                        }
                                        if ( $line =~  /^\s*service_notification_commands\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*service_notification_commands\s+// ;
                                                $l = $l . "  " . $x . "/" ;
                                        }
                                        if ( $line =~  /^\s*host_notification_commands\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*host_notification_commands\s+// ;
                                                $l = $l . $x ;
                                        }
                                        if ( $line =~  /^\s*email\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*email\s+// ;
                                                $l = $l . " -> " . $x  ;
                                                print $l . "\n" if ($quiet) ;
                                        }

                                }
                                last CASE_OBJ;
                        };

                $o eq "contactgroup" && do
                        {
                                if ($contact_info == 0 )
                                {       $o = "";
                                }else{
#print "$line\n";
                                        if ( $line =~  /^\s*contactgroup_name\s+/ )
                                        {
                                                $l = $line;
                                                $l =~ s/^\s*contactgroup_name\s+// ;
                                                $l = "CG: " . $l ;
                                        }
                                        if ( $line =~  /^\s*alias\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^\s*alias\s+// ;
                                                $l = $l . " (" . $x . ")  " ;
                                        }

                                        if ( $line =~  /^\s*members\s+/ )
                                        {
                                                $x = $line;
                                                $x =~ s/^.*members\s+// ;
                                                $l = sprintf("%-40s -> %s", $l ,$x)  ;
                                                print $l . "\n" if ($quiet) ;
                                        }
                                }
                                last CASE_OBJ;
                        };

                        next CFG if ($contact_info == 1 && $all==0);


                $o eq "hostgroup" && do
                        {
                                if ( $line =~  /^\s*hostgroup_name\s+/ )
                                {
                                        $l = $line;
                                        $l =~ s/^\s*hostgroup_name\s+// ;
                                        $l = "HG: " . $l ;
                                }

                                if ( $line =~  /^\s*alias\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^\s*alias\s+// ;
                                        $l = $l . " (" . $x . ")" ;
                                }

                                if ( $line =~  /^\s*members\s+/ )
                                {
                                        if ( $line =~  /[\s\,]+$host,*/ )
                                        {
                                                if ( $host eq "" )
                                                {
                                                        $x = $line;
                                                        $x =~ s/^.*members\s+// ;
                                                        $l = sprintf("%-30s -> %s", $l ,$x)  ;
                                                }
                                        }
                                        else
                                        {       $o = "" ;
                                        }
                                }

                                if ( $line =~  /\}/ )
                                {
                                        print $l . "\n" if ($quiet) ;
                                }
                                last CASE_OBJ;
                        } ;
                $o eq "host" && do
                        {

                                if ( $line =~  /^\s*host_name\s+/ )
                                {
                                        $v = "";
                                        $parents="";
                                        $l = $line;
                                        $l =~ s/^.*host_name\s+// ;
                                        $hn=$l;
                                        #20091113jd if ( $host ne $l )
                                        if ( ! ( $host eq $l || $host_match =~ "#$l#" ) )
                                        {
                                                $o = "" if ($h_serach_mod eq "h" );
                                        } else {

                                                $host = $hn;
                                                $e = 0 if ( $svc eq ""  );
                                        }
                                        $l = " H: " . $l ;
                                }


                                if ( $line =~  /^\s*alias\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*alias\s+// ;
                                        #20091113jd if ( $host eq $x && $h_serach_mod eq "H" && $host ne $hn)
                                        if ( ($host eq $x || $host_match =~ "#$x#" ) && $h_serach_mod eq "H" && $host ne $hn )
                                        {
                                                $host = $hn;
                                                $e = 0 if ( $svc eq "" );
                                        }

                                        $l = $l . " (" . $x . ")" ;
                                }

                                if ( $line =~  /^\s*address\s+/ )
                                {
                                        $a = $line;
                                        $a =~ s/^.*address\s+// ;
                                        if ( $h_serach_mod eq "H" && $host ne $hn)
                                        {
                                                #20091113jd if ( $host eq $a )
                                                if ( $host eq $a || $host_match =~ "#$a#" )
                                                {
                                                        $host = $hn;
                                                        $e = 0 if ( $svc eq "" );
                                                } else {
                                                        $o = "" ;
                                                }
                                        }
                                        $l = $l . " " . $a  ;
                                }

                                if ( $line =~  /^\s*parents\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*parents\s+// ;
                                        $parents=";p=".$x;
                                }

                                if ( $line =~  /^\s*check_period\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*check_period\s+// ;
                                        $l = $l . "   [" . $x . "]"  ;
                                }

                                if ( $line =~  /^\s*check_command\s+/ )
                                {
                                        $c = $line;
                                        $c =~ s/^.*check_command\s+// ;
                                        $l = sprintf("%-60s -> %s", $l ,$c)  ;
                                }

                                if ( $line =~  /^\s*contact_groups\s+/ && ( $contact_info == 1 || $add_cont_info == 1 ) )
                                {
                                        $x = $line;
                                        $x =~ s/^.*contact_groups\s+// ;
                                        $l = $l . "   [" . $x . "]"  ;
                                }
                                if ( $line =~  /^\s*contacts\s+/ && ( $contact_info == 1 || $add_cont_info == 1 ) )
                                {
                                        $x = $line;
                                        $x =~ s/^.*contacts\s+// ;
                                        $l = $l . "   [" . $x . "]"  ;
                                }

                                if ( $line =~  /^\s*check_interval\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*check_interval\s+// ;
                                        $x =~ s/\.000000// ;
                                        $l = $l . " (i=" . $x  ;
                                }

                                if ( $line =~  /^\s*retry_interval\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*retry_interval\s+// ;
                                        $x =~ s/\.000000// ;
                                        $l = $l . "/" . $x  ;
                                }

                                if ( $line =~  /^\s*max_check_attempts\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*max_check_attempts\s+// ;
                                        $l = $l . "{" . $x . "}"  ;
                                }

                                if ( $line =~  /^\s*active_checks_enabled\s+/ )
                                {
                                        $l = $l . ";c=" ;
                                        $l = $l . "a"  if ($line =~ /1$/ ) ;
                                }

                                if ( $line =~  /^\s*passive_checks_enabled\s+/ )
                                {
                                        $l = $l . "p"  if ($line =~ /1$/ ) ;
                                }


                                if ( $line =~  /^\s*freshness_threshold\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*freshness_threshold\s+// ;
                                        $ft=$x;
                                }

                                if ( $line =~  /^\s*check_freshness\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*check_freshness\s+// ;
                                          if ( $x == 1 )
                                            { $l .= ";f=" . $ft ; }
                                          else
                                            { $l .= ";f=d" ; }
                                }

                                if ( $line =~  /^\s*notification_options\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*notification_options\s+// ;
                                        $l = $l . ";n=" . $x . $parents . ")"  ;
                                }

                                if ( $line =~  /^\s*_+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^\s*_/_HOST/ ;
                                        $x =~ s/\s+/='/ ;
                                        $v = $v . $x ."'#!#"  ;
                                }


                                if ( $line =~  /\}/ )
                                {
                                        print $l . "\n" if ($quiet) ;
                                        if  ($add_cmd_info )
                                        {
                                                my @v_unsort=split("#!#",$v);
                                                $v = join(" ", sort(@v_unsort))  ;
                                                print " H: \t\t\tvar: " . $v . "\n" if ($quiet && $v ne "") ;
                                                print " H: \t\t\t" . get_cmd($c) . "\n" if ($quiet) ;
                                        }
                                        if  ($add_host_info )
                                        {
                                                print " H: \t\t" , qx!host $a|egrep -v ';;|SERVFAIL'! if ($quiet) ;
                                        }
                                }
                                last CASE_OBJ;
                        } ;
                $o eq "service" && do
                        {
                                if ( $line =~  /^\s*host_name\s+/ )
                                {
                                        $v = "";
                                        $l = $line;
                                        $l =~ s/^.*host_name\s+// ;
                                        if ( $host ne $l )
                                        {       $o = "" if ($all==0);
                                        }
                                }


                                if ( $line =~  /^\s*service_description\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*service_description\s+// ;

                                        if ( $svc ne "" )
                                        {
                                                if ( $svc ne $x )
                                                {       $o = "" ;
                                                }
                                                else
                                                {
                                                        $e = 0 ;
                                                }
                                        }

                                        if ($all==0)
                                        {
                                                $l = "  S: " . $x  ;
                                        }else{
                                                $l = "  S: $l/$x"  ;
                                        }
                                }

                                if ( $line =~  /^\s*check_period\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*check_period\s+// ;
                                        $l = $l . "   [" . $x . "]"  ;
                                }


                                if ( $line =~  /^\s*check_interval\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*check_interval\s+// ;
                                        $x =~ s/\.000000// ;
                                        $l = $l . " (i=" . $x  ;
                                }

                                if ( $line =~  /^\s*retry_interval\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*retry_interval\s+// ;
                                        $x =~ s/\.000000// ;
                                        $l = $l . "/" . $x  ;
                                }

                                if ( $line =~  /^\s*max_check_attempts\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*max_check_attempts\s+// ;
                                        $l = $l . "{" . $x . "}"  ;
                                }

                                if ( $line =~  /^\s*active_checks_enabled\s+/ )
                                {
                                        $l = $l . ";c=" ;
                                        $l = $l . "a"   if ($line =~ /1$/ ) ;
                                }

                                if ( $line =~  /^\s*passive_checks_enabled\s+/ )
                                {
                                        $l = $l . "p"   if ($line =~ /1$/ ) ;
                                }

                                if ( $line =~  /^\s*freshness_threshold\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*freshness_threshold\s+// ;
                                          $ft=$x;
                                }

                                if ( $line =~  /^\s*check_freshness\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*check_freshness\s+// ;
                                          if ( $x == 1 )
                                            { $l .= ";f=" . $ft ; }
                                          else
                                            { $l .= ";f=d" ; }
                                }


                                if ( $line =~  /^\s*notification_options\s+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^.*notification_options\s+// ;
                                        $l = $l . ";n=" . $x . ")"  ;
                                }

                                if ( $line =~  /^\s*check_command\s+/ )
                                {
                                        $c = $line;
                                        $c =~ s/^.*check_command\s+// ;
                                        $l = sprintf("%-60s -> %s", $l ,$c)  ;
                                }


                                if ( $line =~  /^\s*contact_groups\s+/ && ( $contact_info == 1 || $add_cont_info == 1 ) )
                                {
                                        $x = $line;
                                        $x =~ s/^.*contact_groups\s+// ;
                                        $l = $l . "   [" . $x . "]"  ;
                                }

                                if ( $line =~  /^\s*contacts\s+/ && ( $contact_info == 1 || $add_cont_info == 1 ) )
                                {
                                        $x = $line;
                                        $x =~ s/^.*contacts\s+// ;
                                        $l = $l . "   [" . $x . "]"  ;
                                }

                                if ( $line =~  /^\s*_+/ )
                                {
                                        $x = $line;
                                        $x =~ s/^\s*_/_SERVICE/ ;
                                        $x =~ s/\s+/='/ ;
                                        $v = $v . $x ."'#!#"  ;
                                }


                                if ( $line =~  /\}/ )
                                {
                                        print $l . "\n" if ($quiet) ;
                                        if  ($add_cmd_info )
                                        {
                                                my @v_unsort=split("#!#",$v);
                                                $v = join(" ", sort(@v_unsort))  ;
                                                print "  S:\t\t\tvar: " . $v . "\n" if ($quiet && $v ne "") ;
                                                print "  S: \t\t\t" . get_cmd($c) . "\n" if ($quiet) ;
                                        }
                                }
                                last CASE_OBJ;

                        } ;
        }  # end CASE_OBJ
        $o = "" if ( $line =~  /\}/ ) ;
}

close (CFG);

exit $e;


###########

sub get_cmd {
        my $c = $_[0] ;
        my $line;
        my $o = "";

        $c =~ s/\s+.*// ;
        $c =~ s/!.*// ;

        open(CMD_CFG, $conf) or die "Error: can't open $conf\n";
        while ($line = <CMD_CFG>)
        {
                chomp($line);
                next if ( $line =~  /^\s*#/ );

                if ( $line =~  /^\s*$/ )
                {       $o = "";
                        next;
                }

                if ( $line =~  /define\s+command/ )
                {       $o = "command" ;
                        next;
                }

                next if ( $o ne "command" ) ;

                if ( $line =~  /command_name/ )
                {
                        if ( $line !~  /$c/ )
                        { $o = "" ; }
                }

                if ( $line =~  /command_line/ )
                {
                        $o = $line;
                        $o =~ s/.*command_line\s*// ;
                        close (CMD_CFG);
                        return $o;
                }
        }
        close (CMD_CFG);

        return $c ;
}
