#!/bin/bash
#
# check central
#       restart core
#       restart apache

alarmFile=/tmp/check_and_heal_central
if [ "$( find $alarmFile -mmin +10 2>/dev/null )" = $alarmFile ]
then
    rm $alarmFile
fi

########
# 
# swapFree=$( free | awk '$1 == "Swap:" { print $4+0 }' )
# 
# if [ "$swapFree" -lt 1024000 ]
# then
#     echo "swap: only $swapFree blocks free --> restart core"
#     echo "swap: only $swapFree blocks free --> restart core " >> $alarmFile
#     chown central.central $alarmFile
# 
#     omd restart central core
#     sleep 5
# else
#     echo "swap: ok ($swapFree blocks free)"
# fi
# 
########

#memFree=$( free | awk '$1 == "Mem:" { print $4+0 }' )
memFree=$( free -t | awk '$1 == "Total:" { print $4+0 }' )

if [ "$memFree" -lt 256000 ]
then
    echo "mem+swap: only $memFree blocks free --> restart apache2, omd"
    echo "mem+swap: only $memFree blocks free --> restart apache2, omd " >> $alarmFile
    chown central.central $alarmFile

    service apache2 restart
    omd restart central 
    sleep 5
else
    echo "mem+swap: ok ($memFree blocks free)"
fi

########

for i in 1 2 3
do
    naemonState=$( omd status central naemon |  awk '$1 == "naemon:" { print $2}' )

    echo "naemon: $naemonState"

    if [ "$naemonState" = "running" ]
    then
        break
    fi

    sleep 5
done

if [ "$naemonState" != "running" ]
then
    echo "naemon: $naemonState --> restart core"
    echo "naemon: $naemonState --> restart core " >> $alarmFile
    chown central.central $alarmFile

    omd restart central core
fi


########

cpuApache=$( ps -fu central | grep apache | awk ' { sumCpu += $4} END { print sumCpu+0 }' )

if [ "$cpuApache" -gt 28 ]
then
    echo "apache: cpu=$cpuApache --> restart apache"
    echo "apache: cpu=$cpuApache --> restart apache " >> $alarmFile
    chown central.central $alarmFile

    omd restart central apache
    sleep 5
else
    echo "apache: ok (cpu=$cpuApache)"
fi

#########

for i in 1 2 3
do
    apacheState=$( omd status central apache |  awk '$1 == "apache:" { print $2}' )

    echo "apache: $apacheState"

    if [ "$apacheState" = "running" ]
    then
        break
    fi

    sleep 5
done

if [ "$apacheState" != "running" ]
then
    echo "apache: $apacheState --> restart apache"
    echo "apache: $apacheState --> restart apache " >> $alarmFile
    chown central.central $alarmFile

    omd restart central apache
fi

##########


# delete old naemon states
find /opt/omd/sites/central/tmp/naemon -name 'status.dat*' -mtime +5 -ls -exec rm {} \;
